# Database Synchronization Report
## AWS RDS vs Local Database Comparison

**Date:** October 6, 2025
**Generated By:** Database Analysis Script

---

## Executive Summary

This report compares the AWS RDS production database with the local development database to identify missing tables, triggers, and schema differences.

### Quick Stats
- **AWS RDS Tables:** 100
- **Local DB Tables:** 129
- **Missing Tables in RDS:** 29
- **Missing Triggers in RDS:** 44
- **Tables with Schema Differences:** 9

---

## 1. MISSING TABLES IN AWS RDS

The following 29 tables exist in the local database but are **NOT** in AWS RDS:

### Accounting & Financial Tables (4)
1. `Account` - Chart of accounts
2. `AccountBalance` - Account balance tracking
3. `AccountingPeriod` - Accounting period management
4. `AccountingSettings` - Accounting configuration

### Journal Entry Tables (2)
5. `JournalEntry` - General ledger entries
6. `JournalEntryLine` - Line items for journal entries

### Material Management Tables (5)
7. `MaterialCostHistory` - Historical material cost tracking
8. `MaterialDocument` - Material documentation
9. `MaterialKit` - Material kit definitions
10. `MaterialKitItem` - Items within material kits
11. `MaterialLocationStock` - Stock by location
12. `MaterialVendorPrice` - Vendor pricing for materials

### Notification System Tables (2)
13. `Notification` - Notification records
14. `NotificationPreference` - User notification preferences

### Permissions & Roles Tables (6)
15. `Permission` - Permission definitions
16. `PermissionGroup` - Permission groupings
17. `PermissionGroupMember` - Members of permission groups
18. `Role` - Role definitions
19. `RoleAssignment` - User role assignments
20. `RolePermission` - Permissions assigned to roles

### Purchase Order Tables (2)
21. `PurchaseOrderReceipt` - Purchase order receipts
22. `ReceiptItem` - Individual receipt items

### Stock Management Tables (2)
23. `StockTransfer` - Stock transfers between locations
24. `StockTransferItem` - Items in stock transfers

### Time Entry Enhancements (2)
25. `TimeEntryPhoto` - Photos attached to time entries
26. `TimeEntryRejectionNote` - Rejection notes for time entries

### User Management (2)
27. `UserPermission` - Direct user permissions
28. `UserViewPreference` - User view preferences

### Other (1)
29. `ForecastCache` - Cached forecast data

---

## 2. MISSING TRIGGERS IN AWS RDS

The following 44 triggers exist in the local database but are **NOT** in AWS RDS:

### Accounting Related Triggers (9)
**Table: Account**
- `trigger_account_updated` - Updates timestamp on account changes

**Table: AccountingPeriod**
- `trigger_period_updated` - Updates timestamp on period changes

**Table: AccountingSettings**
- `trigger_settings_updated` - Updates timestamp on settings changes

**Table: JournalEntry**
- `trigger_check_period_open_insert` - Validates period is open on insert
- `trigger_check_period_open_update` - Validates period is open on update
- `trigger_entry_updated` - Updates timestamp on entry changes

**Table: JournalEntryLine**
- `trigger_update_account_balance` - Updates account balances
- `trigger_validate_entry_balance_insert` - Validates balanced entries on insert
- `trigger_validate_entry_balance_update` - Validates balanced entries on update

### Material Management Triggers (12)
**Table: Material**
- `trigger_track_material_cost` - Tracks material cost changes

**Table: MaterialKitItem**
- `trigger_update_kit_totals_delete` - Updates kit totals on delete
- `trigger_update_kit_totals_insert` - Updates kit totals on insert
- `trigger_update_kit_totals_update` - Updates kit totals on update

**Table: MaterialLocationStock**
- `sync_material_stock_on_location_change_delete` - Syncs stock on delete
- `sync_material_stock_on_location_change_insert` - Syncs stock on insert
- `sync_material_stock_on_location_change_update` - Syncs stock on update
- `update_material_location_stock_updated_at` - Updates timestamp

**Table: MaterialVendorPrice**
- `update_material_vendor_price_updated_at` - Updates timestamp

### Permission & Role Triggers (8)
**Table: Permission**
- `update_permission_updated_at` - Updates timestamp

**Table: PermissionGroup**
- `update_permission_group_updated_at` - Updates timestamp

**Table: Role**
- `trigger_log_role_changes_delete` - Logs role deletions
- `trigger_log_role_changes_insert` - Logs role creations
- `trigger_log_role_changes_update` - Logs role updates
- `update_role_updated_at` - Updates timestamp

**Table: UserPermission**
- `trigger_log_permission_change_delete` - Logs permission deletions
- `trigger_log_permission_change_insert` - Logs permission creations
- `trigger_log_permission_change_update` - Logs permission updates

### Purchase Order & Receipt Triggers (5)
**Table: ReceiptItem**
- `trigger_handle_receipt_item_delete` - Handles receipt item deletion
- `trigger_handle_receipt_item_update` - Handles receipt item updates
- `trigger_prevent_over_receipt` - Prevents receiving more than ordered
- `trigger_prevent_over_receipt_on_update` - Prevents over-receipt on update
- `trigger_update_stock_on_receipt` - Updates stock levels on receipt

### Stock Management Triggers (2)
**Table: StockTransfer**
- `update_stock_transfer_updated_at` - Updates timestamp

**Table: StockTransferItem**
- `update_stock_transfer_item_updated_at` - Updates timestamp

### Time Entry Triggers (7)
**Table: TimeEntry**
- `trigger_approved_time_entry` (2 instances) - Handles time entry approval
- `update_time_entry_updated_at_trigger` - Updates timestamp

**Table: TimeEntryAudit**
- `prevent_timeentryaudit_delete` - Prevents audit log deletion
- `prevent_timeentryaudit_update` - Prevents audit log modification

**Table: TimeEntryPhoto**
- `trigger_update_photo_count_delete` - Updates photo count on delete
- `trigger_update_photo_count_insert` - Updates photo count on insert

**Table: TimeEntryRejectionNote**
- `trigger_update_rejection_notes_flag` - Updates rejection flag

### Other Triggers (1)
**Table: EmployeeSchedule**
- `update_employee_schedule_updated_at_trigger` - Updates timestamp

**Table: PayrollPeriod**
- `update_payroll_period_updated_at_trigger` - Updates timestamp

**Table: TimeTrackingSettings**
- `update_time_tracking_settings_updated_at_trigger` - Updates timestamp

---

## 3. SCHEMA DIFFERENCES IN COMMON TABLES

9 tables have schema differences between AWS RDS and Local DB:

### 3.1 FileAttachment
**Columns in RDS but NOT in LOCAL (3):**
- `cdnurl` (text, nullable)
- `s3bucket` (text, nullable)
- `s3key` (text, nullable)

**Impact:** RDS has S3-specific columns that local doesn't have

---

### 3.2 JobAttachment
**Columns in RDS but NOT in LOCAL (2):**
- `s3bucket` (text, nullable)
- `s3key` (text, nullable)

**Impact:** RDS has S3-specific columns that local doesn't have

---

### 3.3 JobLaborCost
**Type Differences (1):**
- `timeEntryId`: RDS=`uuid`, LOCAL=`text`

**Impact:** Data type mismatch - potential issues with joins/references

---

### 3.4 OvertimeSettings
**Columns in RDS but NOT in LOCAL (8):**
- `autoCalculateOvertime` (boolean)
- `dailyRegularHours` (numeric)
- `doubleTimeMultiplier` (numeric)
- `overtimeMode` (text)
- `overtimeMultiplier` (numeric)
- `payPeriodType` (text)
- `weekStartDay` (integer)
- `weeklyRegularHours` (numeric)

**Type Differences (3):**
- `createdAt`: RDS=`timestamp without time zone`, LOCAL=`timestamp with time zone`
- `id`: RDS=`text`, LOCAL=`uuid`
- `updatedAt`: RDS=`timestamp without time zone`, LOCAL=`timestamp with time zone`

**Impact:** MAJOR - RDS has more complete overtime settings structure

---

### 3.5 StockMovement
**Columns in LOCAL but NOT in RDS (2):**
- `clientRequestId` (text)
- `transferId` (text)

**Impact:** Local has additional tracking fields

---

### 3.6 TimeEntry
**Columns in LOCAL but NOT in RDS (2):**
- `hasRejectionNotes` (boolean)
- `photoCount` (integer)

**Columns in RDS but NOT in LOCAL (4):**
- `editapprovedat` (timestamp)
- `editapprovedby` (text)
- `editrequest` (jsonb)
- `editrequestedat` (timestamp)

**Type Differences (1):**
- `approvedBy`: RDS=`text`, LOCAL=`uuid`

**Impact:** Different features - Local has rejection workflow, RDS has edit approval workflow

---

### 3.7 TimeEntryAudit
**Columns in LOCAL but NOT in RDS (4):**
- `changes` (jsonb)
- `correlation_id` (varchar)
- `job_labor_cost_id` (uuid)
- `notes` (text)

**Type Differences (5):**
- `action`: RDS=`text`, LOCAL=`varchar`
- `entry_id`: RDS=`uuid`, LOCAL=`text`
- `ip_address`: RDS=`inet`, LOCAL=`varchar`
- `new_job_id`: RDS=`text`, LOCAL=`uuid`
- `old_job_id`: RDS=`text`, LOCAL=`uuid`

**Impact:** MAJOR - Significant structural differences in audit logging

---

### 3.8 TimeTrackingSettings
**Columns in LOCAL but NOT in RDS (4):**
- `companyId` (uuid, NOT NULL)
- `createdAt` (timestamp, NOT NULL)
- `overtimeThreshold` (numeric)
- `updatedAt` (timestamp, NOT NULL)

**Columns in RDS but NOT in LOCAL (10):**
- `allowgpstracking` (boolean)
- `autoclockoutafterhours` (integer)
- `breakdeductionminutes` (integer)
- `companyid` (uuid)
- `createdat` (timestamp)
- `maxdailyhours` (numeric)
- `overtimethreshold` (numeric)
- `requirephotocheckin` (boolean)
- `roundtonearestminutes` (integer)
- `updatedat` (timestamp)

**Type Differences (2):**
- `overtimeCalculation`: RDS=`varchar`, LOCAL=`ENUM`
- `payPeriodType`: RDS=`varchar`, LOCAL=`ENUM`

**Impact:** MAJOR - Different column naming (camelCase vs lowercase), different features

---

### 3.9 UserAuditLog
**Columns in LOCAL but NOT in RDS (2):**
- `resourceId` (text)
- `severity` (varchar)

**Impact:** Local has additional audit tracking fields

---

## 4. RECOMMENDATIONS

### Priority 1: Critical Tables (Roles & Permissions)
These tables are required for the Roles & Permissions system to work:
1. Migrate `Role`, `RoleAssignment`, `RolePermission`
2. Migrate `Permission`, `PermissionGroup`, `PermissionGroupMember`
3. Migrate `UserPermission`
4. Migrate all associated triggers

### Priority 2: Time Entry Enhancements
Recently developed features:
1. Migrate `TimeEntryPhoto`, `TimeEntryRejectionNote`
2. Add missing columns to `TimeEntry` (hasRejectionNotes, photoCount)
3. Add missing columns to `TimeEntryAudit`
4. Migrate all time entry related triggers

### Priority 3: Material Management
Enhanced material tracking:
1. Migrate material-related tables (MaterialLocationStock, MaterialKit, etc.)
2. Migrate material triggers

### Priority 4: Accounting System
Complete accounting functionality:
1. Migrate accounting tables
2. Migrate journal entry tables and triggers

### Priority 5: Stock & Purchase Management
1. Migrate stock transfer tables
2. Migrate purchase order receipt tables
3. Migrate related triggers

### Priority 6: Schema Alignment
Fix data type and column inconsistencies:
1. Resolve UUID vs TEXT inconsistencies
2. Add missing S3 columns where needed
3. Standardize timestamp types
4. Reconcile TimeTrackingSettings structure

---

## 5. MIGRATION STRATEGY

### Step 1: Export Missing Tables
Generate CREATE TABLE statements for all 29 missing tables from local database

### Step 2: Export Missing Triggers
Generate CREATE TRIGGER statements for all 44 missing triggers from local database

### Step 3: Schema Modifications
Generate ALTER TABLE statements to add missing columns and fix type mismatches

### Step 4: Data Migration
Copy data from local to RDS for tables that need it (especially Roles & Permissions)

### Step 5: Validation
Run comprehensive tests to ensure:
- All tables exist
- All triggers work correctly
- All foreign key relationships are intact
- Application functions properly

---

## Next Steps

1. **Review this report** with the team
2. **Prioritize which tables/triggers to migrate** based on current feature needs
3. **Generate migration scripts** for approved changes
4. **Test migrations** on a staging/backup RDS instance first
5. **Execute production migration** during maintenance window

---

**Report Generated:** October 6, 2025
**Databases Compared:**
- **Local:** `postgresql://localhost/ots_erp_local`
- **AWS RDS:** `ots-erp-prod-rds.c5cymmac2hya.us-east-2.rds.amazonaws.com/ortmeier`
